# 元

开发流程：先看本文档 确定本周计划
当次开发细节 记录到OB&MM里
每次有新的模块、重要文件出现 记得在文件开头写注释 
    并且更新README里的程序结构描述 
        记得调用对应的prompt
            README里对应位置有prompt 

# 单次开发计划 7.26-8.2

**核心目标：** 实现一个在23:00定时触发的状态问卷功能，并在手机端完成数据记录。

---

### **第一步：数据模型与本地存储 (最优先)**

目标：在Flutter应用中定义问卷的数据结构，并建立本地存储机制（请尽量考虑到日后迁移和扩展新模块时的便利性）。

-   **任务1：设计问卷内容与数据模型**
    -   确定问卷项目：
        -   昨晚睡眠时间 (文本输入)
        -   今早起床时间 (文本输入)
        -   睡眠质量 (1-5分)
        -   LAE状态评估 (1-5分)
        -   运动状态评估 (1-5分)
        -   科研状态评估 (1-5分)
        -   饮食情况 (文本输入)
        -   当前焦虑水平 (1-5, 步长0.1)
        -   当前整体状态 (1-5)
        -   备注 (文本输入)
    -   在 `lae_app/lib/models/` 目录下，创建一个新的Dart文件 `status_record.dart`，用于定义状态记录的数据模型。

-   **任务2：实现本地存储**
    -   为Flutter项目添加本地数据库依赖（如 `sqflite`）。
    -   创建一个本地数据库管理类 (`database_helper.dart`)，负责初始化数据库，并编写一个用于插入状态记录的函数。

---

### **第二步：前端UI开发**

目标：构建用户填写问卷的界面。

-   **任务1：创建问卷页面**
    -   在 `lae_app/lib/` 下创建新页面 `status_survey_page.dart`。
    -   设计UI，包含以下控件：
        -   **睡眠/起床时间、饮食、备注**: 使用 `TextField`。
        -   **睡眠质量、LAE/运动/科研状态**: 使用 `Row` 包含5个可点击的 `Icon` 或自定义的 `ChoiceChip` 来实现1-5分的选择。
        -   **焦虑水平、整体状态**: 使用 `Slider` 控件，可设置范围和步长。
    -   添加一个“提交”按钮。点击后，将UI上的数据封装成 `StatusRecord` 对象，并调用第一步中的本地数据库函数进行存储。
注意：以后会有更多模块需要使用“问卷”功能，因此在创建相关脚本、函数、类的时候，请尽量考虑到日后迁移和扩展的便利性。
    以及，日后的问卷可能会有比较复杂的跳转逻辑（比如条件跳转，比如允许返回上一页等）。在设计的时候请考虑到这一点。



---

### **第三步：核心逻辑 - 定时触发**

目标：让应用在指定时间提醒用户填写问卷。

-   **任务1：实现定时通知**
    -   为Flutter项目添加定时任务或本地通知相关依赖（如 `flutter_local_notifications`）。
    -   编写逻辑，设置一个在每日23:00触发的本地通知。
    -   配置该通知，使其在用户点击后能够导航到第二步创建的 `status_survey_page.dart` 问卷页面。

- 任务二 实现按钮触发
    在主界面 增加两个按钮 分别允许按钮触发问卷 以及查看已有回答记录

---
### **第四步：测试和debug **
- 任务一
    - 允许问卷所有题目都留空（即全部非必答题）
- 任务二
    - 修复查看已有记录时显示不完整的bug
- 任务三 
    - 修改问卷（对题目进行修改）
        具体修改内容：睡眠质量等题目从五点选择替换成slider（类似焦虑水平，最小单位同样是0.1），允许留空。
        昨夜睡眠时间（五个选项：-2300;2300-2330;2330-0000;0000-0100;0100-）和今早起床时间（五个选项：-0730;0730-0800;0800-0830;0830-0900;0900-）从自由输入变成单选题,并且按钮上显示的中文（对应的变量名不变）改成：昨晚睡着时间和今早离开床的时间；然后再在这两道题目后面增加两道选择题和一道自由输入题：昨夜入睡用时（-20min;20-60min;60min+）；今早起床用时（-10min;10-20min;20-60min;60min+）睡眠相关异常情况（如床上刷手机，半夜醒来等）（自由输入）
- 任务四
    - 确认定时触发只需要程序在后台运行，无需前台运行；
    - 程序启动时：（为了应对意外中止程序进程的情况）
        - 如果还未到23:00,则检查前一天有无回答记录：如果没有，立刻弹出问卷
        - 如果已经超过 23:00 ，则检查当前有无回答记录：如果没有，立刻弹出问卷




### **第五步：云端同步 (非必须)**

目标：将本地存储的数据上传到Supabase。

-   **任务1：设计云端数据表**
    -   在 `database/schema.sql` 中，为状态问卷设计一个新的数据表 `survey_records`。

-   **任务2：开发上传功能**
    -   在Flutter应用中，编写一个函数，用于读取本地数据库中的状态记录，并通过Supabase API将其批量上传到云端。
        - 需要思考如何避免重复上传。如果直接把本地的所有数据都上传到云端，借助supabase的CONSTRAINT（record_time, survey_type组合防重）不知道是否可行。
    -   在主界面增加按钮，调用上传数据功能

- 任务3 修复上传bug 
    - 目前supabase有两条记录，本地端有五条（新增了一条）。点击按钮上传，报错：I/flutter (22887): Error uploading new records: PostgrestException(message: duplicate key value violates unique constraint "survey_records_record_time_survey_type_key", code: 23505, details: Key (record_time, survey_type)=(2025-08-02 15:00:45.610049+00, daily_status_check) already exists., hint: null)
    但是supabase_service.dart里应该实现了先获得云端已有记录的record_time, survey_type，然后把本地不重复的数据上传上去。因此不该有这个报错。并且脚本还特意注意了时间戳的精度以及时区的问题。那么问题出在哪里呢?
        我需要找个办法 看到每次从云端获得的 比较的 上传的 内容到底是什么
        如果这个流程没问题 那么可能问题出在error是错的（概率小）
    终于修好了 主要是时间戳格式和时区的问题 现在统一以世界时上传到云端以及进行比较
- 任务4： 补充删除功能
    不知道为啥 历史状态记录的删除功能没了
    删除功能：历史状态记录页面 单击某条记录 弹出新窗口 可以查看记录的完整内容 并且在关闭按钮的左边有个删除按钮 点击后删除本条数据 
- 任务5：更新schema 底部的记录


# 下周开发计划 

**核心目标：** 设计并开发“主支线任务管理系统”的最小可行产品 ，实现对长短期目标的层级化跟踪与管理。

---

### **第一步：数据库搭建 **  

目标：在本地和云端建立 `Quest` 和 `Objective` 表的结构。

-   **任务 1：更新数据表结构定义**
    -   在 `database/schema.sql` 文件中，添加 `Quests` (主支线任务) 和 `Objectives` (具体目标) 表的 `CREATE TABLE` 语句。
    -   `Quests` 表需包含 `quest_id`, `name`, `parent_id`, `status`, `progress`, `target_frequency`, `target_duration` 等字段。
    -   `Objectives` 表需包含 `linked_quest_id`, `name`, `status`, `time_type`, `start_date_time`, `end_date_time` 等字段。

-   **任务 2：同步数据库**
    -   在本地，执行更新后的 `schema.sql`，创建 `data_base.db` 中的新表。
    -   在 Supabase 项目后台，使用 SQL 编辑器执行相同的 `CREATE TABLE` 语句，创建云端数据表。

---

### **第二步：后端开发 (Python) **

目标：编写脚本以管理本地数据，并实现与云端的同步。

-   **任务 1：创建本地数据管理模块**
    -   在 `src/` 目录下创建一个新文件，例如 `quest_manager.py`。
    -   在此文件中，编写基础的 CRUD (创建, 读取, 更新, 删除) 函数，用于操作本地 SQLite 数据库中的 `Quests` 和 `Objectives` 表。

-   **任务 2：实现数据同步逻辑**
    -   在 `src/supabase_client.py` 中，添加新的函数，用于将本地 `Quests` 和 `Objectives` 表的数据变更推送至 Supabase，并从 Supabase 拉取更新。
    -   MVP 阶段，可实现一个简单的单向或双向同步函数，由主脚本定时调用。

---

### **第三步：前端开发 (Flutter) **

目标：构建用于展示和管理任务与目标的用户界面。

-   **任务 1：创建数据模型和服务**
    -   在 `lae_app/lib/` 下创建 `models` 文件夹，并定义 `quest.dart` 和 `objective.dart` 数据模型类。
    -   在 `lae_app/lib/` 下创建 `services` 文件夹，并创建 `api_service.dart` 或 `supabase_service.dart`，用于封装与 Supabase 后端的数据交互逻辑 (获取、新增、更新任务与目标)。

-   **任务 2：开发核心UI页面**
    -   **主线任务列表页 (`quest_list_page.dart`)**:
        -   从 Supabase 获取并以层级形式展示所有 `Quests`。
        -   提供一个浮动按钮(+)用于添加新的主线任务。
    -   **任务详情页 (`quest_detail_page.dart`)**:
        -   点击列表中的某个 `Quest` 后跳转至此页面。
        -   显示该 `Quest` 的详细信息 (`description`, `progress` 等)。
        -   展示与此 `Quest` 关联的所有 `Objectives` 列表。
    -   **目标/日程表单页 (`objective_form_page.dart`)**:
        -   用于创建或编辑一个 `Objective`。
        -   包含名称、状态、时间类型、起止时间等输入字段。

---

### **第四步：集成与测试 **

目标：确保前后端能够协同工作，数据流转正确。

-   **任务 1：端到端测试**
    -   在 Flutter 应用中创建一个新任务。
    -   验证数据是否成功写入 Supabase。
    -   运行 Python 后端同步脚本，验证数据是否成功同步到本地 SQLite 数据库。
    -   反向测试：在本地数据库直接修改数据，运行同步脚本，验证 Supabase 和 Flutter 应用中数据是否更新。

-   **任务 2：文档更新**
    -   更新 `README.md` 中的项目结构，加入 `src/quest_manager.py` 等新文件。