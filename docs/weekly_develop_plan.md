# 元

开发流程：先看本文档 确定本周计划
当次开发细节 记录到OB&MM里
每次有新的模块、重要文件出现 记得在文件开头写注释 
    并且更新README里的程序结构描述 
        记得调用对应的prompt
            README里对应位置有prompt 

# 单次开发计划 7.26-8.2--定时弹出状态问卷雏形

**核心目标：** 实现一个在23:00定时触发的状态问卷功能，并在手机端完成数据记录。

---

### **第一步：数据模型与本地存储 (最优先)**

目标：在Flutter应用中定义问卷的数据结构，并建立本地存储机制（请尽量考虑到日后迁移和扩展新模块时的便利性）。

-   **任务1：设计问卷内容与数据模型**
    -   确定问卷项目：
        -   昨晚睡眠时间 (文本输入)
        -   今早起床时间 (文本输入)
        -   睡眠质量 (1-5分)
        -   LAE状态评估 (1-5分)
        -   运动状态评估 (1-5分)
        -   科研状态评估 (1-5分)
        -   饮食情况 (文本输入)
        -   当前焦虑水平 (1-5, 步长0.1)
        -   当前整体状态 (1-5)
        -   备注 (文本输入)
    -   在 `lae_app/lib/models/` 目录下，创建一个新的Dart文件 `status_record.dart`，用于定义状态记录的数据模型。

-   **任务2：实现本地存储**
    -   为Flutter项目添加本地数据库依赖（如 `sqflite`）。
    -   创建一个本地数据库管理类 (`database_helper.dart`)，负责初始化数据库，并编写一个用于插入状态记录的函数。

---

### **第二步：前端UI开发**

目标：构建用户填写问卷的界面。

-   **任务1：创建问卷页面**
    -   在 `lae_app/lib/` 下创建新页面 `status_survey_page.dart`。
    -   设计UI，包含以下控件：
        -   **睡眠/起床时间、饮食、备注**: 使用 `TextField`。
        -   **睡眠质量、LAE/运动/科研状态**: 使用 `Row` 包含5个可点击的 `Icon` 或自定义的 `ChoiceChip` 来实现1-5分的选择。
        -   **焦虑水平、整体状态**: 使用 `Slider` 控件，可设置范围和步长。
    -   添加一个“提交”按钮。点击后，将UI上的数据封装成 `StatusRecord` 对象，并调用第一步中的本地数据库函数进行存储。
注意：以后会有更多模块需要使用“问卷”功能，因此在创建相关脚本、函数、类的时候，请尽量考虑到日后迁移和扩展的便利性。
    以及，日后的问卷可能会有比较复杂的跳转逻辑（比如条件跳转，比如允许返回上一页等）。在设计的时候请考虑到这一点。



---

### **第三步：核心逻辑 - 定时触发**

目标：让应用在指定时间提醒用户填写问卷。

-   **任务1：实现定时通知**
    -   为Flutter项目添加定时任务或本地通知相关依赖（如 `flutter_local_notifications`）。
    -   编写逻辑，设置一个在每日23:00触发的本地通知。
    -   配置该通知，使其在用户点击后能够导航到第二步创建的 `status_survey_page.dart` 问卷页面。

- 任务二 实现按钮触发
    在主界面 增加两个按钮 分别允许按钮触发问卷 以及查看已有回答记录

---
### **第四步：测试和debug **
- 任务一
    - 允许问卷所有题目都留空（即全部非必答题）
- 任务二
    - 修复查看已有记录时显示不完整的bug
- 任务三 
    - 修改问卷（对题目进行修改）
        具体修改内容：睡眠质量等题目从五点选择替换成slider（类似焦虑水平，最小单位同样是0.1），允许留空。
        昨夜睡眠时间（五个选项：-2300;2300-2330;2330-0000;0000-0100;0100-）和今早起床时间（五个选项：-0730;0730-0800;0800-0830;0830-0900;0900-）从自由输入变成单选题,并且按钮上显示的中文（对应的变量名不变）改成：昨晚睡着时间和今早离开床的时间；然后再在这两道题目后面增加两道选择题和一道自由输入题：昨夜入睡用时（-20min;20-60min;60min+）；今早起床用时（-10min;10-20min;20-60min;60min+）睡眠相关异常情况（如床上刷手机，半夜醒来等）（自由输入）
- 任务四
    - 确认定时触发只需要程序在后台运行，无需前台运行；
    - 程序启动时：（为了应对意外中止程序进程的情况）
        - 如果还未到23:00,则检查前一天有无回答记录：如果没有，立刻弹出问卷
        - 如果已经超过 23:00 ，则检查当前有无回答记录：如果没有，立刻弹出问卷




### **第五步：云端同步 (非必须)**

目标：将本地存储的数据上传到Supabase。

-   **任务1：设计云端数据表**
    -   在 `database/schema.sql` 中，为状态问卷设计一个新的数据表 `survey_records`。

-   **任务2：开发上传功能**
    -   在Flutter应用中，编写一个函数，用于读取本地数据库中的状态记录，并通过Supabase API将其批量上传到云端。
        - 需要思考如何避免重复上传。如果直接把本地的所有数据都上传到云端，借助supabase的CONSTRAINT（record_time, survey_type组合防重）不知道是否可行。
    -   在主界面增加按钮，调用上传数据功能

- 任务3 修复上传bug 
    - 目前supabase有两条记录，本地端有五条（新增了一条）。点击按钮上传，报错：I/flutter (22887): Error uploading new records: PostgrestException(message: duplicate key value violates unique constraint "survey_records_record_time_survey_type_key", code: 23505, details: Key (record_time, survey_type)=(2025-08-02 15:00:45.610049+00, daily_status_check) already exists., hint: null)
    但是supabase_service.dart里应该实现了先获得云端已有记录的record_time, survey_type，然后把本地不重复的数据上传上去。因此不该有这个报错。并且脚本还特意注意了时间戳的精度以及时区的问题。那么问题出在哪里呢?
        我需要找个办法 看到每次从云端获得的 比较的 上传的 内容到底是什么
        如果这个流程没问题 那么可能问题出在error是错的（概率小）
    终于修好了 主要是时间戳格式和时区的问题 现在统一以世界时上传到云端以及进行比较
- 任务4： 补充删除功能
    不知道为啥 历史状态记录的删除功能没了
    删除功能：历史状态记录页面 单击某条记录 弹出新窗口 可以查看记录的完整内容 并且在关闭按钮的左边有个删除按钮 点击后删除本条数据 
- 任务5：更新schema 底部的记录

# 8.9-8.15 提醒&日程管理系统  (数据库驱动版)

感觉会有很多内容 一周大概率开发不完 但是我太开心太激动了 如果真的能上线 就是我个人的一大步 LAE的一大步 啊啊啊啊啊啊啊啊呜呜呜呜呜我拖了tmd不知道多久 我一定要让它上线无论要花多久tmd（但也别太久） 我要好好思考一下怎么开始 怎么写计划 怎么把咱们已经有的本地表给利用起来哈哈哈哈哈哈


**核心目标：** 搭建一个由数据库驱动的、单向的定时提醒框架。实现从“电脑端手动输入数据 -> 云端同步 -> 手机端接收提醒”的完整核心链路，为后续的智能主支线管理系统打下坚实的数据和机制基础。

---

### **第一步：数据库地基搭建 (最优先)**

**目标：** 在本地和云端定义并创建支撑“提醒&日程管理”所需的数据表结构，使其具备未来扩展性。

* **任务1：设计并更新数据表结构 (`schema.sql`)**
    * 在 `database/schema.sql` 文件中，正式定义 `Quests` (主支线任务)、`Objectives` (具体目标/日程) 和新增的 `Routines` (作息规则) 表。
    * **思路：**
        * `Quests` 表应包含ID、名称、描述、所属主线等字段，用于宏观目标管理。
        * `Objectives` 表是核心，应包含ID、关联的`Quest` ID、名称、状态，以及最重要的 `start_date_time` 和 `end_date_time` 等时间字段，用于驱动具体日程。
        * `Routines` 表用于存放固定、重复的提醒，应包含ID、提醒内容、提醒时间（例如仅有时分）等字段。

* **任务2：同步数据库结构**
    * 在本地SQLite数据库 (`data_base.db`) 中执行更新后的 `schema.sql` 脚本，创建新的数据表。
    * 在Supabase云端项目中，同样执行该脚本，确保云端与本地表结构一致。

感觉这里也要注意 在doc里 写清楚 queusts ddl 日程 任务 作息等分别是啥子！

---

### **第二步：数据生成与填充**

**目标：** 为新创建的表填充初始的、真实的个人数据，以便后续开发和测试。

* **任务1：设计AI指令 (Prompt) 以生成数据**
    * **思路：** 为了高效、批量地将您的个人目标和作息转换为结构化数据，需要设计一个AI指令。此指令应能理解您的自然语言描述，并输出可直接用于数据库的格式（如SQL `INSERT` 语句）。
    * **示例指令框架：**
        > “你是一个数据库助理。我会用自然语言描述我的主线任务(Quests)、具体目标(Objectives)和日常作息(Routines)。请根据我提供的表结构（[在此处粘贴`Quests`, `Objectives`, `Routines`表的CREATE TABLE语句]），将我的描述转换成对应的SQL INSERT语句。
        >
        > 我的描述如下：
        > [例如：我有一个主线任务叫'硕士阶段的科研与学习'。这个主线下，我本周有一个具体目标是'完成数据分析方法文献的梳理'，计划在8月12日上午9点到11点进行。另外，我有一个每天都要执行的作息提醒，在早上8点提醒我'活动身体，晒太阳'。]”

* **任务2：生成并手动填充初始数据**
    * 使用您设计的AI指令，将您真实的DDL、个人目标、作息规则转换为SQL语句。
    * 在本地SQLite数据库中执行这些SQL语句，完成数据的初始填充。

---

### **第三步：后端数据同步 (Python脚本)**

**目标：** 开发一个Python脚本，实现将本地数据库中的日程、任务数据单向同步至Supabase云端。

* **任务1：开发数据同步核心逻辑**
    * 在 `src/` 目录下创建新的Python脚本（或在现有脚本中扩展）。
    * **思路：** 脚本的核心功能是读取本地 `data_base.db` 中 `Objectives` 和 `Routines` 表的数据，然后连接到Supabase，并将这些数据推送至云端对应的表中。需要考虑如何处理数据更新和避免重复上传的机制。

---

### **第四步：手机端核心逻辑开发 (Flutter)**

**目标：** 让Flutter应用能够从云端获取日程数据，并根据时间设置本地定时通知。

* **任务1：开发数据获取服务**
    * **思路：** 在Flutter项目中，创建一个服务类，负责在应用启动或特定时机，通过Supabase API拉取 `Objectives` 和 `Routines` 表的全部数据，并将其存储在App的内存或本地缓存中。

* **任务2：开发提醒调度引擎**
    * **思路：** 遍历从云端获取到的日程和作息数据。根据每条记录的提醒时间，调用系统的本地通知服务，为每一条未来的、有效的日程都安排一个定时通知。需要设计好通知的内容，使其能清晰地展示任务或作息的名称。

---

### **第五步：手机端UI开发与展示**

**目标：** 创建一个简单的只读界面，用于验证和展示从云端同步过来的日程数据，确保数据流正确无误。

* **任务1：创建日程只读列表页面**
    * **思路：** 新建一个页面，该页面UI非常简洁，主要是一个列表，用于展示从云端获取并缓存在应用内的所有 `Objectives` 和 `Routines`。这可以帮助您直观地确认数据同步是否成功，以及提醒引擎的数据源是否正确。

---

### **第六步：端到端集成与测试**

**目标：** 验证整个数据流和功能链路能够按预期工作。

* **任务1：执行完整的测试流程**
    * **思路：**
        1.  在本地`data_base.db`中手动新增或修改一条未来时间的`Objective`记录。
        2.  运行第三步开发的Python同步脚本，检查Supabase后台数据是否已更新。
        3.  重新启动Flutter应用，进入第五步创建的只读列表页面，确认新的日程是否已显示。
        4.  等待或将手机时间调整到该日程的提醒时间点，验证是否能准时收到预期的本地通知。



# 下阶段开发计划 -- 仅供参考，可能会被拆分到其他开发计划里 因此可能不会被实际采用

**核心目标：** 设计并开发“主支线任务管理系统”的最小可行产品 ，实现对长短期目标的层级化跟踪与管理。

---

### **第一步：数据库搭建 **  

目标：在本地和云端建立 `Quest` 和 `Objective` 表的结构。

-   **任务 1：更新数据表结构定义**
    -   在 `database/schema.sql` 文件中，添加 `Quests` (主支线任务) 和 `Objectives` (具体目标) 表的 `CREATE TABLE` 语句。
    -   `Quests` 表需包含 `quest_id`, `name`, `parent_id`, `status`, `progress`, `target_frequency`, `target_duration` 等字段。
    -   `Objectives` 表需包含 `linked_quest_id`, `name`, `status`, `time_type`, `start_date_time`, `end_date_time` 等字段。

-   **任务 2：同步数据库**
    -   在本地，执行更新后的 `schema.sql`，创建 `data_base.db` 中的新表。
    -   在 Supabase 项目后台，使用 SQL 编辑器执行相同的 `CREATE TABLE` 语句，创建云端数据表。

---

### **第二步：后端开发 (Python) **

目标：编写脚本以管理本地数据，并实现与云端的同步。

-   **任务 1：创建本地数据管理模块**
    -   在 `src/` 目录下创建一个新文件，例如 `quest_manager.py`。
    -   在此文件中，编写基础的 CRUD (创建, 读取, 更新, 删除) 函数，用于操作本地 SQLite 数据库中的 `Quests` 和 `Objectives` 表。

-   **任务 2：实现数据同步逻辑**
    -   在 `src/supabase_client.py` 中，添加新的函数，用于将本地 `Quests` 和 `Objectives` 表的数据变更推送至 Supabase，并从 Supabase 拉取更新。
    -   MVP 阶段，可实现一个简单的单向或双向同步函数，由主脚本定时调用。

---

### **第三步：前端开发 (Flutter) **

目标：构建用于展示和管理任务与目标的用户界面。

-   **任务 1：创建数据模型和服务**
    -   在 `lae_app/lib/` 下创建 `models` 文件夹，并定义 `quest.dart` 和 `objective.dart` 数据模型类。
    -   在 `lae_app/lib/` 下创建 `services` 文件夹，并创建 `api_service.dart` 或 `supabase_service.dart`，用于封装与 Supabase 后端的数据交互逻辑 (获取、新增、更新任务与目标)。

-   **任务 2：开发核心UI页面**
    -   **主线任务列表页 (`quest_list_page.dart`)**:
        -   从 Supabase 获取并以层级形式展示所有 `Quests`。
        -   提供一个浮动按钮(+)用于添加新的主线任务。
    -   **任务详情页 (`quest_detail_page.dart`)**:
        -   点击列表中的某个 `Quest` 后跳转至此页面。
        -   显示该 `Quest` 的详细信息 (`description`, `progress` 等)。
        -   展示与此 `Quest` 关联的所有 `Objectives` 列表。
    -   **目标/日程表单页 (`objective_form_page.dart`)**:
        -   用于创建或编辑一个 `Objective`。
        -   包含名称、状态、时间类型、起止时间等输入字段。

---

### **第四步：集成与测试 **

目标：确保前后端能够协同工作，数据流转正确。

-   **任务 1：端到端测试**
    -   在 Flutter 应用中创建一个新任务。
    -   验证数据是否成功写入 Supabase。
    -   运行 Python 后端同步脚本，验证数据是否成功同步到本地 SQLite 数据库。
    -   反向测试：在本地数据库直接修改数据，运行同步脚本，验证 Supabase 和 Flutter 应用中数据是否更新。

-   **任务 2：文档更新**
    -   更新 `README.md` 中的项目结构，加入 `src/quest_manager.py` 等新文件。